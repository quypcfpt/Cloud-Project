@page
@{
    ViewData["Title"] = "Profile";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div id="content">
    <div class="row page-titles">
        <div class="col-md-5 col-8 align-self-center">
            <h3 class="text-themecolor">Thông tin tài khoản</h3>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-area="" asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                <li class="breadcrumb-item active">Thông tin cá nhân</li>
            </ol>
        </div>
    </div>
    <div class="row">
        <!-- Column -->
        <div class="col-lg-4 col-xlg-3 col-md-5">
            <div class="card">
                <div class="card-body">
                    <center class="m-t-30" id="center">
                        <div id="review_container_edit">
                            <img src="~/assets/images/users/Vidant_Default_Profile.png" class="img-circle" width="200" height="200" id="image" />
                        </div>

                        <h4 class="card-title m-t-10" id="fullname"></h4>
                        <input type="hidden" name="bannerUrl" id="editbannerUrl" value="" />
                        <input type="button" class="btn btn-info" id="btnChangeImage" value="Thay đổi ảnh đại diện" />
                        <input type="hidden" value="" id="id" />
                    </center>

                </div>
                <div>
                    <hr>
                </div>
                <div class="card-body">
                    <small class="text-muted">Email</small>
                    <h6 id="email"></h6> <small class="text-muted p-t-30 db">Số điện thoại</small>
                    <h6 id="phonenumber"></h6> 
                </div>
            </div>
        </div>
        <!-- Column -->
        <!-- Column -->
        <div class="col-lg-8 col-xlg-9 col-md-7">
            <div class="card">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs profile-tab" role="tablist">
                    <li class="nav-item"> <a class="nav-link active" data-toggle="tab" href="#profile" role="tab">Thông tin</a> </li>
                    <li class="nav-item"> <a class="nav-link" data-toggle="tab" href="#settings" role="tab">Cài đặt</a> </li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div class="tab-pane active" id="profile" role="tabpanel">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 col-xs-6 b-r">
                                    <strong>Họ và tên</strong>
                                    <br>
                                    <p class="text-muted" id="fullName">...</p>
                                </div>
                                <div class="col-md-3 col-xs-6 b-r">
                                    <strong>Tên tài khoản</strong>
                                    <br>
                                    <p class="text-muted" id="userName"></p>
                                </div>
                                <div class="col-md-3 col-xs-6 b-r">
                                    <strong>Email</strong>
                                    <br>
                                    <p class="text-muted" id="emailDetail"></p>
                                </div>
                                <div class="col-md-3 col-xs-6">
                                    <strong>Điện thoại</strong>
                                    <br>
                                    <p class="text-muted" id="phonenumberDetail"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="settings" role="tabpanel">
                        <div class="card-body">
                            <form class="form-horizontal form-material">
                                <div class="form-group">
                                    <label class="col-md-12">Họ và tên</label>
                                    <div class="col-md-12">
                                        <input type="text" placeholder="Nhập họ và tên" class="form-control form-control-line" id="fullnameEdit">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-email" class="col-md-12">Email</label>
                                    <div class="col-md-12">
                                        <input type="email" placeholder="Nhập địa chỉ email" class="form-control form-control-line" name="example-email" id="emailEdit">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-12">Số điện thoại</label>
                                    <div class="col-md-12">
                                        <input type="text" placeholder="123 456 7890" class="form-control form-control-line" id="phonenumberEdit">
                                    </div>
                                </div>
                            </form>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <button class="btn btn-success" id="btnUpdateProfile">Update Profile</button>
                                </div>
                                @*<div class="col-sm-12">
                                        <input type="button" class="btn btn-info" id="btnChangePassword" value="Thay đổi mật mã" onclick="showChangePassword()" />
                                    </div>*@
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Column -->
        </div>
    </div>
</div>


@section Scripts{
    <script src="//static.filestackapi.com/filestack-js/1.x.x/filestack.min.js"></script>
    <script>
        var updateProfile = function () {
            var formData = new FormData();
            formData.append('email', $('#emailEdit').val());
            formData.append('fullName', $('#fullnameEdit').val());
            formData.append('phoneNumber', $('#phonenumberEdit').val());
            $.ajax({
                url: `${configuration.BASE_API_URL}Account/update`,
                headers: {
                    "Authorization": `${configuration.ACCESSTOKEN}`,
                },
                method: "PUT",
                data: formData,
                processData: false,
                contentType: false,
                success: function (result) {
                    if (result.success) {
                        $.toast({
                            heading: result.data.title,
                            text: result.data.msg,
                            position: 'top-right',
                            loaderBg: '#ffff',
                            icon: 'success',
                            hideAfter: 3500,
                            stack: 6
                        });
                        initData();
                        $('.nav-tabs a[href="#profile"]').tab('show');
                    } else {
                        $.toast({
                            heading: result.data.title,
                            text: result.data.msg,
                            position: 'top-right',
                            loaderBg: '#ffff',
                            icon: 'error',
                            hideAfter: 3500
                        });
                    }
                },
                error: function (result) {
                    $.toast({
                        heading: result.data.title,
                        text: result.data.msg,
                        position: 'top-right',
                        loaderBg: '#ffff',
                        icon: 'error',
                        hideAfter: 3500
                    });
                }
            });
        }
       

        window.addEventListener('DOMContentLoaded', function () {
            const apikey = 'ALBSfS3M1T7C2AGUh7VLgz';
            const client = filestack.init(apikey);
            const options = {
                //displayMode: 'inline',
                //container: '#picker_container',
                maxFiles: 1,
                accept: [
                    "image/jpeg",
                    "image/jpg",
                    "image/png",
                    "image/bmp",
                    "image/gif",
                ],
                fromSources: ['local_file_system', 'url', 'imagesearch'],
                uploadInBackground: false,
                onOpen: () => console.log('opened picker!'),
                onUploadDone: (res) => uploadDoneCallBack(res),
            };
            var picker = client.picker(options);
            var fileHandle = "";
            function uploadDoneCallBack(res) {
                var oldUrl = $("#editbannerUrl").val();
                var oldHandle = oldUrl.replace("https://cdn.filestackcontent.com/", "");
                var url = res.filesUploaded[0].url;
                var mimetype = res.filesUploaded[0].mimetype;
                var handle = res.filesUploaded[0].handle;
                $("#editbannerUrl").val(url);
                $("#review_container_edit").children().remove().end();
                /*Change control base on mime type*/
                $("#review_container_edit").append("<img src='https://cdn.filestackcontent.com/resize=height:200/" + handle + "' alt='Preview-loading' class='img-circle' width='200' height='200' id='image'/>");
                if (oldHandle != "") {
                    /*Delete previous uploaded file*/
                    var policy = "eyJleHBpcnkiOjE1NTY3MjgyMDAsImNhbGwiOlsicGljayIsInJlYWQiLCJzdGF0Iiwid3JpdGUiLCJ3cml0ZVVybCIsInN0b3JlIiwiY29udmVydCIsInJlbW92ZSIsImV4aWYiLCJydW5Xb3JrZmxvdyJdfQ==";
                    var signature = "aaa963b3bb26464d169985d838baf3067818b2917dc31beedba7f0a64f117086";
                    var delUrl = "https://www.filestackapi.com/api/file/" + oldHandle + "?key=" + apikey + "&policy=" + policy + "&signature=" + signature;
                    $.ajax({
                        type: "DELETE",
                        url: delUrl,
                        success: function (res) {
                            console.log(res);
                        }
                    });
                }

                $.ajax({
                    type: "PUT",
                    url: `${configuration.BASE_API_URL}Account/updateAvatar?avatarUrl=` + $('#editbannerUrl').val(),
                    headers: {
                        "Authorization": `${configuration.ACCESSTOKEN}`,
                    },
                    success: function (result) {
                        $.toast({
                            heading: result.title,
                            text: result.msg,
                            position: 'top-right',
                            loaderBg: '#ffff',
                            icon: 'success',
                            hideAfter: 3500,
                            stack: 6
                        });
                    }, error: function (result) {
                        $.toast({
                            heading: result.title,
                            text: result.msg,
                            position: 'top-right',
                            loaderBg: '#ffff',
                            icon: 'error',
                            hideAfter: 3500
                        });
                    }

                })
            }
            btnChangeImage.addEventListener('click', () => picker.open());
        });
        var initPasswordField = function () {
            $('#passwordEdit').focusin(function () { $('#passwordEdit').attr("type", "text"); });
            $('#passwordEdit').focusout(function () { $('#passwordEdit').attr("type", "password"); });
        }

        var initData = function () {
            $.ajax({
                url: `${configuration.BASE_API_URL}Account/getProfile`,
                headers: {
                    "Authorization": `${configuration.ACCESSTOKEN}`,
                },
                method: "GET",
                processData: false,
                success: function (result) {
                    if (result.data.id !== null) {
                        $('#id').val(result.data.id);
                    }
                    if (result.data.avartarUrl !== null) {
                        $('#editbannerUrl').val(result.data.bannerUrl);
                        $("#review_container_edit").children().remove().end();
                        var oldHandle = result.data.avartarUrl.replace("https://cdn.filestackcontent.com/", "");
                        $("#review_container_edit").append("<img src='https://cdn.filestackcontent.com/resize=height:200/" + oldHandle + "' alt='Preview-loading' class='img-circle' width='200' height='200' id='image'/>");
                    }
                    //for (var key in result.data) {
                    //    alert(key +"_"+ result.data[key]);
                    //}
                    $('#fullname').text(result.data.fullName);
                    $('#fullnameEdit').val(result.data.fullName);

                    if (result.data.fullName != null) {
                        $('#fullName').text(result.data.fullName);
                    }
                    if (result.data.email !== null) {
                        $('#email').text(result.data.email);
                        $('#emailDetail').text(result.data.email);
                        $('#emailEdit').val(result.data.email);
                    }
                    if (result.data.phoneNumber !== null) {
                        $('#phonenumber').text(result.data.phoneNumber);
                        $('#phonenumberDetail').text(result.data.phoneNumber);
                        $('#phonenumberEdit').val(result.data.phoneNumber);
                    }
                    if (result.data.userName !== null) {
                        $('#userName').text(result.data.userName);
                    }
                }
            })
        }
        $(document).ready(function () {
            $('#btnUpdateProfile').click(function () {
                updateProfile();
            })
            initData();
            //initPasswordField();
        })
    </script>
}
