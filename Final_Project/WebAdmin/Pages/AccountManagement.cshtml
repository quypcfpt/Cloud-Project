@page
@model WebAdmin.Pages.AccountManagementModel
@{
    ViewData["Title"] = "AccountManagement";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="row page-titles">
    <div class="col-md-5 col-8 align-self-center">
        <h3 class="text-themecolor">Dashboard</h3>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-area="" asp-controller="Home" asp-action="Index">Quản lý tài khoản</a></li>
            <li class="breadcrumb-item active">Dashboard</li>
        </ol>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Tài khoản</h4>
                <h6 class="card-subtitle">Quản lý danh sách tài khoản</h6>
                <form class="form-material m-t-40 row">
                    <div class="form-group col-md-6 m-t-20">
                        <label class="col-3 col-form-label">Vai trò: </label>
                        <select id="roleFilterList" class="custom-select col-8" onchange="refreshData()">
                            <option value="" selected="selected">Chọn vai trò</option>
                            <option value="4496bee7-3c80-4c7c-a9f0-d789140eb379">Quản lí hệ thống</option>
                            <option value="4ef8b744-9273-40a8-9d0c-3081481cb980">Poster</option>
                        </select>
                    </div>
                    <div class="form-group col-md-6 m-t-20">
                        <label class="col-3 col-form-label">Trạng thái: </label>
                        <select id="statusFilterList" class="custom-select col-8" onchange="refreshData()">
                            <option value="-1" selected="selected">Chọn trạng thái</option>
                            <option value="0">Chờ duyệt</option>
                            <option value="1">Đang hoạt động</option>
                            <option value="2">Ngừng hoạt động</option>
                        </select>
                    </div>
                </form>
                <div class="table-responsive m-t-40">
                    @* --------------------ACCOUNT DATATABLE---------------------- *@
                    <table id="accountTable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Tên</th>
                                <th>Hình đại diện</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    @* --------------------END ACCOUNT DATATABLE--------------------- *@
                </div>
            </div>
        </div>
    </div>
</div>
@* --------------ADD NEW ACCOUNT MODAL------------------ *@
<div class="modal fade" id="CreateAccountModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 font-weight-bold">Tạo tài khoản</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body mx-3">
                <form class="form p-t-20" method="post" id="CreateAccountForm">
                    <div class="form-group">
                        <label for="name_create">Tên tài khoản</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" name="username" id="createUsername" placeholder="Nhập tên tài khoản" value="banana">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_create">Mật khẩu</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="password" class="form-control" name="password" id="password" placeholder="Nhập mật khẩu" value="Qwerty@1234">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_create">Nhập lại mật khẩu</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="password" class="form-control" name="confirmPassword" id="confirmPassword" placeholder="Nhập lại mật khẩu" value="Qwerty@1234">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_create">Tên</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" name="fullName" id="fullName" placeholder="Nhập họ tên">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_create">Email</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" name="email" id="email" placeholder="Nhập email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_create">Số điện thoại</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" name="phone" id="phone" placeholder="Nhập số điện thoại">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="avatarUrl">Hình đại diện</label>
                        <input type="button" class="btn btn-info" id="btnChange" value="Upload" />
                        <div class="input-group">
                            <input type="hidden" name="avatarUrl" id="avatarUrl" value="" />
                            <input type="hidden" name="SecurityHash" id="txtSecurityHash" value="" />

                            <div id="review_container"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="roleName">Vai trò</label>
                        <label class="custom-control custom-radio">
                            <input id="organizationRole" name="roleName" value="User" type="radio" class="custom-control-input">
                            <span class="custom-control-label">Poster</span>
                        </label>
                        <label class="custom-control custom-radio">
                            <input checked id="systemRole" name="roleName" value="System Manager" type="radio" class="custom-control-input">
                            <span class="custom-control-label">Hệ thống</span>
                        </label>
                    </div>
                    <input type="hidden" id="accountStatus" value="1">
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="submit" id="btnCreateAccount" class="btn btn-success waves-effect waves-light m-r-10">Tạo</button>
            </div>
        </div>
    </div>
</div>
@* -----------------------END CREATE ACCOUNT MODAL---------------------------- *@

@* --------------EDIT ACCOUNT MODAL------------------ *@
<div class="modal fade" id="EditAccountModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 font-weight-bold">Cập nhật tài khoản</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body mx-3">
                <form class="form p-t-20" method="post" id="EditAccountForm">
                    <div class="form-group">
                        <label for="name_create">Tên tài khoản</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input disabled type="text" class="form-control" name="username" id="editUsername" placeholder="Nhập tên tài khoản">
                        </div>
                    </div>
                    @*<div class="form-group">
                            <label for="name_create">Mật khẩu</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">
                                        <i class="ti-user"></i>
                                    </span>
                                </div>
                                <input disabled type="password" class="form-control" name="password" id="editPassword" placeholder="Nhập mật khẩu">
                            </div>
                        </div>*@
                    <div class="form-group">
                        <label for="name_create">Tên</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" name="fullName" id="editFullName" placeholder="Nhập họ tên">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_create">Email</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" name="email" id="editEmail" placeholder="Nhập email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name_create">Số điện thoại</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">
                                    <i class="ti-user"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" name="phone" id="editPhone" placeholder="Nhập số điện thoại">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="avatarUrl">Hình đại diện</label>
                        <input type="button" class="btn btn-info" id="btnChangeImage" value="Upload" />
                        <div class="input-group">
                            <input type="hidden" name="imageUrl" id="editAvatarUrl" value="" />
                            <input type="hidden" name="SecurityHash" id="txtSecurityHash" value="" />

                            <div id="review_container_edit"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="roleName">Vai trò</label>
                        <label class="custom-control custom-radio">
                            <input id="editOrganizationRole" name="editRoleName" value="User" type="radio" class="custom-control-input">
                            <span class="custom-control-label">Poster</span>
                        </label>
                        <label class="custom-control custom-radio">
                            <input id="editSystemRole" name="editRoleName" value="System Manager" type="radio" class="custom-control-input">
                            <span class="custom-control-label">Hệ thống</span>
                        </label>
                    </div>
                    <input type="hidden" id="editUserId" value="" />
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="submit" id="btnEditAccount" class="btn btn-success waves-effect waves-light m-r-10">Lưu</button>
            </div>
        </div>
    </div>
</div>
@* --------------END EDIT ACCOUNT MODAL------------------ *@

@* ----Start Update Status ----- *@

<div class="modal fade" id="UpdateStatusModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 font-weight-bold">Cập nhật trạng thái</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <input type="hidden" id="accountId" value="" />
            <div class="modal-body mx-3 d-flex justify-content-center">
                <button type="button" class="btn btn-success waves-effect waves-light m-r-10" onclick="updateStatus(1)">Hoạt động</button>
                <button type="button" class="btn btn-danger waves-effect waves-light m-r-10" onclick="updateStatus(2)">Ngừng hoạt động</button>
            </div>
        </div>
    </div>
</div>

@* ----End Update Status ------- *@

@section Scripts{
    <!-- This is data table -->
    <script src="../assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <!--This page css - Morris CSS -->
    <script src="~/assets/plugins/raphael/raphael-min.js"></script>
    <script src="~/assets/plugins/morrisjs/morris.js"></script>
    <!-- Optional -->
    <script src="~/assets/plugins/cdn.datatables.net/buttons/1.2.2/js/buttons.html5.min.js"></script>
    <script src="~/assets/plugins/cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js"></script>
    <script src="//static.filestackapi.com/filestack-js/1.x.x/filestack.min.js"></script>

    <script>
        var actionAdd = true;

        //method to init account datatable
        var initAccountDatatable = function () {
            $('#accountTable').DataTable({
                "ajax": {
                    "url": `${configuration.BASE_API_URL}Account/getAccountsByFilterSystemAdministrator`,
                    "headers": {
                        "Authorization": `${configuration.ACCESSTOKEN}`,
                    },
                    "data": function (data) {
                        data.roleId = $('#roleFilterList option:selected').val();
                        data.status = $('#statusFilterList option:selected').val();
                    },
                    "method": "GET",
                },
                "buttons": [
                    {
                        text: '<i class="left-icon fa fa-plus"></i>&nbsp;Tạo tài khoản',
                        className: 'dt-button-success',
                        action: function (e, dt, node, config) {
                            $("#organizationCollapse").hide();  //hide organization list when open create modal
                            $('#CreateAccountModal').modal("show");
                            actionAdd = true;
                        }
                    },
                ],
                "dom": 'Bftip',
                "columns": [
                    { data: 'userName' },
                    { data: 'fullName' },
                    {
                        data: 'avartarUrl', render: function (data) {
                            return '<img src="' + data + '" width="100" height="100"/>'
                        }
                    },
                    {
                        data: 'status',
                        render: function (data, type, row) {
                            if (data == 0) {
                                return '<span class="label label-warning" onclick="openUpdateStatusModal(\'' + row["id"] + '\')">Chờ duyệt</span>'
                            }
                            if (data == 1) {
                                return '<span class="label label-success" onclick="openUpdateStatusModal(\'' + row["id"] + '\')">Đang hoạt động</span>'
                            }
                            else {
                                return '<span class="label label-danger" onclick="openUpdateStatusModal(\'' + row["id"] + '\')">Ngừng hoạt động</span>'
                            }

                        }
                    },
                    {
                        data: 'id', render: function (data, type, row) {
                            return '<button type="submit" class="btn btn-success" data-toggle="modal" data-target="#EditAccountModal" onclick="getAccountDetails(\'' + data + '\')"><i class="fa fa-pencil"></i></button>'
                        }
                    }
                ],
            });
        };

        //method to add new account
        var addNewAccount = function () {

            var password = $('#password').val();
            var confirmPassword = $("#confirmPassword").val();
            var username = $('#createUsername').val();
    var email = $('#email').val();
            var name = $('#fullName').val();
    var roleName = "User";
   

            if (!regexpass.test(password)) {
                $.toast({
                    heading: "Mật khẩu không hợp lệ",
                    text: "Mật khẩu phải ít nhất 8 kí tự gồm 1 chữ hoa, 1 số, 1 chữ thường và 1 kí tự đặc biệt",
                    position: 'top-right',
                    loaderBg: '#ffff',
                    icon: 'error',
                    hideAfter: 3500
                });
        return;
    }

            if (password !== confirmPassword) {
                $.toast({
                    heading: "Mật khẩu không hợp lệ",
                    text: "Mật khẩu xác nhận không đúng",
                    position: 'top-right',
                    loaderBg: '#ffff',
                    icon: 'error',
                    hideAfter: 3500
                });
        return;
    }
            if (username === "" || password === "" || confirmPassword === "" || email === "") {
                $.toast({
                    heading: "Chưa nhập đủ thông tin",
                    text: "Mật khẩu xác nhận không đúng",
                    position: 'top-right',
                    loaderBg: '#ffff',
                    icon: 'error',
                    hideAfter: 3500
                });
                return;
    }

            var formData = new FormData();
            formData.append('userName', username);
            formData.append('password', password);
            formData.append("confirmPassword", confirmPassword);
            formData.append('fullName', name);
            formData.append('email', email);
            formData.append('phoneNumber', $('#phone').val());
            formData.append('avartarUrl', $('#avatarUrl').val());
            formData.append('status', $('#accountStatus').val());

            var roleValue = $("input[name='roleName']:checked").val();
            formData.append('roleId', roleValue);



            $.ajax({
                url: `${configuration.BASE_API_URL}Account/register`,
                headers: {
                    "Authorization": `${configuration.ACCESSTOKEN}`,
                },
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (result) {
                    $.toast({
                        heading: result.msg,
                        text: result.msg,
                        position: 'top-right',
                        loaderBg: '#ffff',
                        icon: 'success',
                        hideAfter: 3500,
                        stack: 6
                    });
                    $('#accountTable').DataTable().ajax.reload();
                    $('#CreateAccountModal').modal('hide');
                },
                error: function (result) {
                    $.toast({
                        heading: result.msg,
                        text: result.msg,
                        position: 'top-right',
                        loaderBg: '#ffff',
                        icon: 'error',
                        hideAfter: 3500
                    });
                }
            });
        };

        //method to edit profile
        var editProfile = function () {
            var formData = new FormData();
            formData.append('userName', $('#editUsername').val());
            formData.append('fullName', $('#editFullName').val());
            formData.append('email', $('#editEmail').val());
            formData.append('phoneNumber', $('#editPhone').val());
            formData.append('avartarUrl', $('#editAvatarUrl').val());
            formData.append('id', $('#editUserId').val());

            var roleValue = $("input[name='editRoleName']:checked").val();
            formData.append('RoleId', roleValue);

            if ($("input[id='editOrganizationRole']").is(':checked')) {
                formData.append('organizationId', $('#editOrganizationList').val());
            }

            $.ajax({
                url: `${configuration.BASE_API_URL}Account/update`,
                headers: {
                    "Authorization": `${configuration.ACCESSTOKEN}`,
                },
                method: "PUT",
                data: formData,
                processData: false,
                contentType: false,
                success: function (result) {
                    if (result.success) {
                        $.toast({
                            heading: result.data.title,
                            text: result.data.msg,
                            position: 'top-right',
                            loaderBg: '#ffff',
                            icon: 'success',
                            hideAfter: 3500,
                            stack: 6
                        });
                        $('#accountTable').DataTable().ajax.reload();
                        $('#EditAccountModal').modal('hide');
                    }
                },
                error: function (result) {
                    $.toast({
                        heading: result.data.title,
                        text: result.data.msg,
                        position: 'top-right',
                        loaderBg: '#ffff',
                        icon: 'error',
                        hideAfter: 3500
                    });
                }
            });
        };

        //method to get account details
        var getAccountDetails = function (id) {
            actionAdd = false;
            //$('#editOrganizationCollapse').hide();  //hide organization list when open edit modal

            $.ajax({
                url: `${configuration.BASE_API_URL}Account/getProfile?id=${id}`,
                headers: {
                    "Authorization": `${configuration.ACCESSTOKEN}`,
                },
                method: "POST",
                processData: false,
                contentType: false,
                success: function (data) {
                    $('#editUsername').val(data.data.userName);
                    $('#editFullName').val(data.data.fullName);
                    $('#editEmail').val(data.data.email);
                    $('#editPhone').val(data.data.phoneNumber);

                    if (data.data.roleId == "System Manager") {
                        $('#editSystemRole').prop('checked', true);
                    } else if (data.data.roleId == "User") {
                        $('#editOrganizationRole').prop('checked', true);
                    }

                    if (data.data.avartarUrl != null) {
                        $('#editAvatarUrl').val(data.data.avartarUrl);
                        $("#btnChangeImage").val("Change");
                        $("#review_container_edit").children().remove().end();
                        var oldHandle = data.data.avartarUrl.replace("https://cdn.filestackcontent.com/", "");
                        $("#review_container_edit").append("<img src='https://cdn.filestackcontent.com/resize=height:250/" + oldHandle + "' alt='Preview-loading'/>");
                    }
                    $('#editUserId').val(data.data.id);
                },
                error: function (result) {
                    $.toast({
                        heading: result.data.title,
                        text: result.data.msg,
                        position: 'top-right',
                        loaderBg: '#ffff',
                        icon: 'error',
                        hideAfter: 3500
                    });
                }
            });
        };

        //method to popup update status modal
        function openUpdateStatusModal(accountId) {
            $("#UpdateStatusModal").modal("show");
            $("#accountId").val(accountId);
        }

        //method to update status
        function updateStatus(statusNum) {
            var accountId = $("#accountId").val();
            $.ajax({
                url: `${configuration.BASE_API_URL}Account/updateStatus?userId=${accountId}&status=${statusNum}`,
                headers: {
                    "Authorization": `${configuration.ACCESSTOKEN}`,
                },
                method: "PUT",
                contentType: false,
                success: function (result) {
                    if (result.success) {
                        $.toast({
                            heading: result.data.title,
                            text: result.data.msg,
                            position: 'top-right',
                            loaderBg: '#ffff',
                            icon: 'success',
                            hideAfter: 3500,
                            stack: 6
                        });
                    } else {
                        $.toast({
                            heading: result.data.title,
                            text: result.data.msg,
                            position: 'top-right',
                            loaderBg: '#ffff',
                            icon: 'error',
                            hideAfter: 3500
                        });
                    }
                    $('#accountTable').DataTable().ajax.reload();
                    $("#UpdateStatusModal").modal('hide');
                },
                error: function (result) {
                    $.toast({
                        heading: result.data.title,
                        text: result.data.msg,
                        position: 'top-right',
                        loaderBg: '#ffff',
                        icon: 'error',
                        hideAfter: 3500
                    });
                }
            });
        }

        $(document).ready(function () {
            //init account datatable
            initAccountDatatable();

            //click button to add new account
            $("#btnCreateAccount").click(function () {
                addNewAccount();
            });

            //click button to edit profile
            $("#btnEditAccount").click(function () {
                editProfile();
            });
        });

        function refreshData() {
            $('#accountTable').DataTable().ajax.reload();
        }

    </script>
    <script>
        //implement filestack
        window.addEventListener('DOMContentLoaded', function () {
            const apikey = 'AY9VEV5GRdSOkw8IWhupGz';
            const client = filestack.init(apikey);
            const options = {
                maxFiles: 1,
                accept: [
                    "image/jpeg",
                    "image/jpg",
                    "image/png",
                    "image/bmp",
                    "image/gif",
                ],
                fromSources: ['local_file_system', 'url', 'imagesearch'],
                uploadInBackground: false,
                onOpen: () => console.log('opened picker!'),
                onUploadDone: (res) => uploadDoneCallBack(res),
            };
            var picker = client.picker(options);
            function uploadDoneCallBack(res) {
                if (actionAdd) {
                    var oldUrl = $("#avatarUrl").val();
                } else {
                    var oldUrl = $("#editAvatarUrl").val();
                }

                var oldHandle = oldUrl.replace("https://cdn.filestackcontent.com/", "");
                var url = res.filesUploaded[0].url;
                var mimetype = res.filesUploaded[0].mimetype;
                var handle = res.filesUploaded[0].handle;
                if (actionAdd) {
                    $("#avatarUrl").val(url);
                    $("#btnChange").val("Change");
                    $("#review_container").children().remove().end();
                    /*Change control base on mime type*/
                    $("#review_container").append("<img src='https://cdn.filestackcontent.com/resize=height:250/" + handle + "' alt='Preview-loading'/>");
                } else {
                    $("#editImageUrl").val(url);
                    $("#btnChangeImage").val("Change");
                    $("#review_container_edit").children().remove().end();
                    /*Change control base on mime type*/
                    $("#review_container_edit").append("<img src='https://cdn.filestackcontent.com/resize=height:250/" + handle + "' alt='Preview-loading'/>");
                }

                if (oldHandle != "") {
                    /*Delete previous uploaded file*/
                    var policy = "eyJleHBpcnkiOjE1NjI5NDkwMDAsImNhbGwiOlsicGljayIsInJlYWQiLCJ3cml0ZSIsIndyaXRlVXJsIiwic3RvcmUiLCJyZW1vdmUiXSwibWluU2l6ZSI6MTI4LCJtYXhTaXplIjoxMDI0MDAwMH0==";
                    var signature = "c62700d678f85375b02e3750e6d569525977f3fbf1e5c131266c79ae5ae05482";
                    var delUrl = "https://www.filestackapi.com/api/file/" + oldHandle + "?key=" + apikey + "&policy=" + policy + "&signature=" + signature;
                    $.ajax({
                        type: "DELETE",
                        url: delUrl,
                        success: function (res) {
                            console.log(res);
                        }
                    });
                }
            }
            btnChange.addEventListener('click', () => picker.open());
            btnChangeImage.addEventListener('click', () => picker.open());
        });
    </script>
}
